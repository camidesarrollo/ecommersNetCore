import { GetByName } from './categoria.api.js';
import Swal from '../../bundle/notifications/vendors_sweetalert.js';

/* js\application\categorias\generic.js */
document.addEventListener('DOMContentLoaded', () => {
    setupSlugAutoGeneration();
    setupGradientSelector();
    setupLivePreview();
});

/* =====================================================
   SLUG AUTOMÁTICO
===================================================== */
export function setupSlugAutoGeneration() {
    const nameInput = document.querySelector('[name="Name"]');
    const slugInput = document.querySelector('[name="Slug"]');

    if (!nameInput || !slugInput) return;

    nameInput.addEventListener('input', e => {
        if (!slugInput.value || slugInput.dataset.autoGenerated) {
            slugInput.value = generateSlug(e.target.value);
            slugInput.dataset.autoGenerated = 'true';
        }
    });

    // Si el usuario edita el slug manualmente
    slugInput.addEventListener('input', () => {
        delete slugInput.dataset.autoGenerated;
    });
}

export function generateSlug(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
}

/* =====================================================
   SELECTOR DE GRADIENTES
===================================================== */
export function setupGradientSelector() {
    const button = document.getElementById('gradientButton');
    const dropdown = document.getElementById('gradientDropdown');
    const input = document.getElementById('BgClass');
    const preview = document.getElementById('gradientPreview');
    const label = document.getElementById('gradientLabel');

    if (!button || !dropdown || !input) return;

    // Abrir / cerrar
    button.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });

    // Selección
    dropdown.querySelectorAll('[data-value]').forEach(option => {
        option.addEventListener('click', () => {
            const value = option.dataset.value;
            const text = option.querySelector('span')?.textContent ?? '';

            input.value = value;
            input.dispatchEvent(new Event('change', { bubbles: true }));

            if (preview) preview.className = `w-8 h-8 rounded-md ${value}`;
            if (label) {
                label.textContent = text;
                label.classList.replace('text-gray-500', 'text-gray-700');
            }

            dropdown.classList.add('hidden');
        });
    });

    // Cerrar al click fuera
    document.addEventListener('click', (e) => {
        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
}

/* =====================================================
   PREVIEW EN TIEMPO REAL
===================================================== */
export function setupLivePreview() {
    const nameInput = document.querySelector('[name="Name"]');
    const shortDescInput = document.querySelector('[name="ShortDescription"]');
    const bgClassInput = document.querySelector('[name="BgClass"]');
    const imageInput = document.getElementById('imageInput');
    const isActiveInput = document.getElementById('isActiveSwitch');

    const namePreview = document.getElementById('NamePreview');
    const shortDescPreview = document.getElementById('ShortDescriptionPreview');
    const bgClassView = document.getElementById('BgClassView');
    const imagePreview = document.getElementById('ImageFilePreview');
    const bgClassLabelPreview = document.getElementById('BgClassLabelPreview');
    const statusIconPreview = document.getElementById('StatusIconPreview');
    const statusLabelPreview = document.getElementById('StatusLabelPreview');

    // Nombre
    if (nameInput && namePreview) {
        nameInput.addEventListener('input', () => {
            namePreview.textContent =
                nameInput.value.trim() || 'Nombre de Categoría';
        });
    }

    // Descripción corta
    if (shortDescInput && shortDescPreview) {
        shortDescInput.addEventListener('input', () => {
            shortDescPreview.textContent =
                shortDescInput.value.trim() || 'Descripción breve de la categoría';
        });
    }

    // Gradiente
    if (bgClassInput && bgClassView) {
        bgClassInput.addEventListener('change', () => {
            const value = bgClassInput.value;
            if (!value) return;

            // Remover clases de gradiente anteriores
            bgClassView.className = bgClassView.className
                .split(' ')
                .filter(c => !c.startsWith('bg-gradient') && !c.startsWith('from-') && !c.startsWith('to-'))
                .join(' ')
                .trim();

            // Agregar nuevas clases de gradiente
            bgClassView.classList.add(...value.split(' '));

            // Actualizar label del preview
            if (bgClassLabelPreview) {
                const gradientName = getGradientName(value);
                bgClassLabelPreview.textContent = gradientName;
            }
        });
    }

    // Estado Activo/Inactivo
    if (isActiveInput && statusIconPreview && statusLabelPreview) {
        const updateStatusPreview = () => {
            if (isActiveInput.checked) {
                statusIconPreview.className = 'fas fa-circle text-mint-green-700';
                statusLabelPreview.textContent = 'Activa';
            } else {
                statusIconPreview.className = 'fas fa-circle text-gray-400';
                statusLabelPreview.textContent = 'Inactiva';
            }
        };

        // Actualizar al cargar y al cambiar
        updateStatusPreview();
        isActiveInput.addEventListener('change', updateStatusPreview);
    }

    // Imagen - No duplicar funcionalidad del image-handler.js
    // Solo actualizar el preview específico si es necesario
    if (imageInput && imagePreview) {
        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];

            if (!file) {
                hideImagePreview(imagePreview);
                return;
            }

            if (!validateImage(file, imageInput)) {
                hideImagePreview(imagePreview);
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });
    }
}

/* =====================================================
   HELPERS
===================================================== */
export function validateImage(file, input) {
    const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
    const maxSize = 2 * 1024 * 1024; // 2MB

    if (!validTypes.includes(file.type)) {
        alert('Formato de imagen no válido. Use JPG, PNG o WEBP.');
        input.value = '';
        return false;
    }

    if (file.size > maxSize) {
        alert('La imagen no debe superar los 2MB');
        input.value = '';
        return false;
    }

    return true;
}

export function hideImagePreview(img) {
    img.src = '';
    img.style.display = 'none';
}

export function getGradientName(gradientClass) {
    const gradientMap = {
        'bg-gradient-to-br from-lime-yellow to-magenta-strong': 'Lima → Magenta',
        'bg-gradient-to-br from-golden-yellow to-nut-brown': 'Dorado → Marrón',
        'bg-gradient-to-br from-beige to-mint-green': 'Beige → Menta',
        'bg-gradient-to-br from-beige to-golden-yellow': 'Beige → Dorado'
    };

    return gradientMap[gradientClass] || 'Gradiente personalizado';
}

$('#Name').on('blur', function () {

    const nombre = $(this).val().trim();
    if (!nombre) return;

    const id = parseInt($('#Id').val()) || 0;

    GetByName({ id: id, name: nombre })
        .then(response => {

            if (response.message == 'Categoría obtenida correctamente.') {
                $('#Name').val('').focus();
                $("#Slug").val('').focus();
                Swal.fire({
                    icon: 'warning',
                    title: 'Categoría duplicada',
                    text: 'Ya existe una categoría con ese nombre',
                });
            }

        })
        .catch(error => {
            console.error(error);
        });
});
