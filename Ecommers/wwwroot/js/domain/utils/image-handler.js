/* js\application\categorias\generic.js */

/* =====================================================
   INIT
===================================================== */
document.addEventListener('DOMContentLoaded', () => {
    setupSlugAutoGeneration();
    setupGradientSelector();
    setupLivePreview();
});

/* =====================================================
   SLUG AUTOMÁTICO
===================================================== */
export function setupSlugAutoGeneration() {
    const nameInput = document.querySelector('[name="Name"]');
    const slugInput = document.querySelector('[name="Slug"]');

    if (!nameInput || !slugInput) return;

    nameInput.addEventListener('input', e => {
        if (!slugInput.value || slugInput.dataset.autoGenerated) {
            slugInput.value = generateSlug(e.target.value);
            slugInput.dataset.autoGenerated = 'true';
        }
    });

    slugInput.addEventListener('input', () => {
        delete slugInput.dataset.autoGenerated;
    });
}

export function generateSlug(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
}

/* =====================================================
   SELECTOR DE GRADIENTES
===================================================== */
export function setupGradientSelector() {
    const button = document.getElementById('gradientButton');
    const dropdown = document.getElementById('gradientDropdown');
    const input = document.getElementById('BgClass');
    const preview = document.getElementById('gradientPreview');
    const label = document.getElementById('gradientLabel');

    if (!button || !dropdown || !input) return;

    button.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });

    dropdown.querySelectorAll('[data-value]').forEach(option => {
        option.addEventListener('click', () => {
            const value = option.dataset.value;
            const text = option.querySelector('span')?.textContent ?? '';

            input.value = value;
            input.dispatchEvent(new Event('change', { bubbles: true }));

            if (preview) preview.className = `w-8 h-8 rounded-md ${value}`;
            if (label) {
                label.textContent = text;
                label.classList.replace('text-gray-500', 'text-gray-700');
            }

            dropdown.classList.add('hidden');
        });
    });

    document.addEventListener('click', e => {
        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
}

/* =====================================================
   PREVIEW EN TIEMPO REAL
===================================================== */
export function setupLivePreview() {
    const nameInput = document.querySelector('[name="Name"]');
    const shortDescInput = document.querySelector('[name="ShortDescription"]');
    const bgClassInput = document.querySelector('[name="BgClass"]');
    const isActiveInput = document.getElementById('isActiveSwitch');

    const namePreview = document.getElementById('NamePreview');
    const shortDescPreview = document.getElementById('ShortDescriptionPreview');
    const bgClassView = document.getElementById('BgClassView');
    const bgClassLabelPreview = document.getElementById('BgClassLabelPreview');
    const statusIconPreview = document.getElementById('StatusIconPreview');
    const statusLabelPreview = document.getElementById('StatusLabelPreview');

    if (nameInput && namePreview) {
        nameInput.addEventListener('input', () => {
            namePreview.textContent =
                nameInput.value.trim() || 'Nombre de Categoría';
        });
    }

    if (shortDescInput && shortDescPreview) {
        shortDescInput.addEventListener('input', () => {
            shortDescPreview.textContent =
                shortDescInput.value.trim() || 'Descripción breve de la categoría';
        });
    }

    if (bgClassInput && bgClassView) {
        bgClassInput.addEventListener('change', () => {
            const value = bgClassInput.value;
            if (!value) return;

            bgClassView.className = bgClassView.className
                .split(' ')
                .filter(c =>
                    !c.startsWith('bg-gradient') &&
                    !c.startsWith('from-') &&
                    !c.startsWith('to-')
                )
                .join(' ')
                .trim();

            bgClassView.classList.add(...value.split(' '));

            if (bgClassLabelPreview) {
                bgClassLabelPreview.textContent = getGradientName(value);
            }
        });
    }

    if (isActiveInput && statusIconPreview && statusLabelPreview) {
        const updateStatusPreview = () => {
            if (isActiveInput.checked) {
                statusIconPreview.className = 'fas fa-circle text-mint-green-700';
                statusLabelPreview.textContent = 'Activa';
            } else {
                statusIconPreview.className = 'fas fa-circle text-gray-400';
                statusLabelPreview.textContent = 'Inactiva';
            }
        };

        updateStatusPreview();
        isActiveInput.addEventListener('change', updateStatusPreview);
    }

    syncImagePreviewToCard();
}

/* =====================================================
   PRIVADOS
===================================================== */
function syncImagePreviewToCard() {
    const imageInput = document.getElementById('imageInput');
    const cardImagePreview = document.getElementById('ImageFilePreview');

    if (!imageInput || !cardImagePreview) return;

    imageInput.addEventListener('change', () => {
        const file = imageInput.files[0];

        if (!file) {
            cardImagePreview.src = '';
            cardImagePreview.style.display = 'none';
            return;
        }

        const reader = new FileReader();
        reader.onload = e => {
            cardImagePreview.src = e.target.result;
            cardImagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    });
}

function getGradientName(gradientClass) {
    const gradientMap = {
        'bg-gradient-to-br from-lime-yellow to-magenta-strong': 'Lima → Magenta',
        'bg-gradient-to-br from-golden-yellow to-nut-brown': 'Dorado → Marrón',
        'bg-gradient-to-br from-beige to-mint-green': 'Beige → Menta',
        'bg-gradient-to-br from-beige to-golden-yellow': 'Beige → Dorado'
    };

    return gradientMap[gradientClass] || 'Gradiente personalizado';
}

/* domain/utils/image-handler.js */

export const ImagePreviewHandler = {
    init() {
        const imageInput = document.getElementById('imageInput');
        const mainPreview = document.getElementById('imagePreview');

        if (!imageInput || !mainPreview) {
            console.warn('ImagePreviewHandler: elementos no encontrados');
            return;
        }

        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];

            if (!file) {
                mainPreview.src = '';
                mainPreview.classList.add('hidden');
                return;
            }

            if (!file.type.startsWith('image/')) {
                console.warn('El archivo seleccionado no es una imagen');
                imageInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                mainPreview.src = e.target.result;
                mainPreview.classList.remove('hidden');
            };

            reader.readAsDataURL(file);
        });
    }
};