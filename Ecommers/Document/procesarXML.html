<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Excel â†’ XML ProductVariants</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            max-height: 300px;
            overflow: auto;
        }
    </style>
</head>

<body>

    <h2>Subir Excel y generar XML</h2>

    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <br>
    <button onclick="processExcel()">Generar XML</button>

    <h3>XML generado</h3>
    <pre id="output"></pre>

    <script>
        function excelDateToISO(value) {
            if (!value) return new Date().toISOString();

            // Fecha como serial Excel
            if (!isNaN(value)) {
                return new Date((value - 25569) * 86400 * 1000).toISOString();
            }

            // Fecha como texto dd-mm-yyyy
            if (typeof value === "string" && value.includes("-")) {
                const parts = value.split("-");
                if (parts.length === 3) {
                    const [d, m, y] = parts;
                    return new Date(`${y}-${m}-${d}T00:00:00`).toISOString();
                }
            }

            return new Date().toISOString();
        }

        function isValidSKU(value) {
            // Ej: ACE-AMA-500G-GRA
            return typeof value === "string" && /^[A-Z0-9]+(-[A-Z0-9]+)+$/.test(value);
        }

        function processExcel() {
            const fileInput = document.getElementById('excelFile');
            if (!fileInput.files.length) {
                alert("Selecciona un archivo Excel");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets["ProductVariants"];

                if (!sheet) {
                    alert("No existe la hoja ProductVariants");
                    return;
                }

                const rows = XLSX.utils.sheet_to_json(sheet, {
                    header: 1,
                    defval: ""
                });

                let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<ProductVariants>\n`;

                rows.forEach((row, i) => {
                    const firstCell = row[0];

                    // ðŸ‘‰ Detectar fila de nombre de producto (ej: "Aceitunas amargas")
                    if (
                        typeof row[0] === "string" &&
                        row[0].trim() !== "" &&
                        !isValidSKU(row[0]) &&
                        row[0].toUpperCase() !== "SKU" &&
                        row.slice(1).every(cell => cell === "")
                    ) {
                        currentProductName = row[0].trim();
                        return;
                    }

                    // ðŸ‘‰ Solo procesar SKUs vÃ¡lidos
                    if (!isValidSKU(firstCell)) return;

                    const sku = firstCell;
                    const precio = Number(row[2]) || 0;
                    const costo = Number(row[4]) || 0;

                    xml += `  <Variant name="${escapeXml(currentProductName)}">\n`;
                    xml += `    <SKU>${escapeXml(sku)}</SKU>\n`;
                    xml += `    <Name>${escapeXml(row[1])}</Name>\n`;
                    xml += `    <Price>${precio}</Price>\n`;
                    xml += `    <CompareAtPrice>${row[3] || ""}</CompareAtPrice>\n`;
                    xml += `    <CostPrice>${costo}</CostPrice>\n`;
                    xml += `    <StockQuantity>${row[5] || 0}</StockQuantity>\n`;
                    xml += `    <ManageStock>${row[6] || 0}</ManageStock>\n`;
                    xml += `    <StockStatus>${row[7]}</StockStatus>\n`;
                    xml += `    <IsDefault>${row[8] || 0}</IsDefault>\n`;
                    xml += `    <IsActive>${row[9] || 0}</IsActive>\n`;
                    xml += `    <CreatedAt>${excelDateToISO(row[10])}</CreatedAt>\n`;
                    xml += `  </Variant>\n`;
                });

                xml += `</ProductVariants>`;

                document.getElementById("output").textContent = xml;
                downloadXML(xml);
            };

            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        function escapeXml(value) {
            return String(value).replace(/[<>&'"]/g, c => ({
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                "'": '&apos;',
                '"': '&quot;'
            }[c]));
        }

        function downloadXML(xml) {
            const blob = new Blob([xml], { type: "application/xml" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "product_variants.xml";
            a.click();

            URL.revokeObjectURL(url);
        }
    </script>


</body>

</html>